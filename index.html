<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Flood Finder Ajax</title>
    <!-- Leaflet CSS map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
        }
        header {
            background-color: #5c90b5;
            color: #304361;
            text-align: center;
            padding: 20px 10px;
            position: relative;
        }
        .logo {
            max-width: 150px;
            height: auto;
            display: block;
            margin: 0 auto 10px;
            border-radius: 10%;
        }
        header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        /* Dark Mode styles */
        .dark-mode {
            background-color: #2b2b2b;
            color: #e0e0e0;
        }
        .dark-mode header {
            background-color: #444;
            color: #fff;
        }
        .dark-mode .form-container {
            background-color: #3a3a3a;
            color: #e0e0e0;
        }
        .dark-mode .alert-item {
            background-color: #555;
            border: 1px solid #666;
        }
        /* Toggle button in header */
        .toggle-theme {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            background-color: #304361;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
        }
        .map-container {
            flex: 1;
            min-width: 60%;
            height: 600px;
            border-right: 2px solid #ddd;
        }
        .form-container {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            background-color: #fff;
        }
        .form-container h2 {
            color: #304361;
            margin-top: 0;
        }
        .dark-mode .form-container h2 {
            color: #5c90b5;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .form-group input,
        .form-group textarea,
        .form-group select,
        .form-group button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .form-group button {
            background-color: #5c90b5;
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 1em;
            margin-top: 5px;
        }
        .dark-mode .form-group button {
            background-color: #304361;
        }
        .form-group button:hover {
            background-color: #487CA1;
        }
        .alert-list {
            margin-top: 20px;
        }
        .alert-list h2 {
            color: #304361;
        }
        .dark-mode .alert-list h2 {
            color: #5c90b5;
        }
        .alert-item {
            background-color: #e6f7ff;
            border: 1px solid #b3e0ff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            position: relative;
        }
        .alert-item button.remove-alert {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #ff5c5c;
            border: none;
            color: #fff;
            border-radius: 50%;
            padding: 5px 5px;
            cursor: pointer;
        }
        .clear-alerts {
            background-color: #ff5c5c;
            border: none;
            color: #fff;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<header>
    <!-- Logo Image -->
    <img src="FFAjax.png" alt="FFAjax Logo" class="logo" />
    <h1>Flood Finder Ajax</h1>
    <p>Report local flooding, keep the community up-to-date.</p>
    <button class="toggle-theme" id="toggleTheme">Toggle Dark Mode</button>
</header>

<div class="container">
    <div class="map-container" id="map"></div>
    <div class="form-container">
        <!-- Report a Flood -->
        <h2>Report a Flood</h2>
        <form id="alertForm">
            <!-- Moved Address field to be first -->
            <div class="form-group">
                <label for="location">Address/Street Name (Ajax, Ontario) *Type or double click on map</label>
                <input type="text" id="location" placeholder="e.g. 123 Main St." required>
            </div>
            <div class="form-group">
                <label for="severity">Severity</label>
                <select id="severity" required>
                    <option value="mild">Mild</option>
                    <option value="medium">Medium</option>
                    <option value="severe">Severe</option>
                </select>
            </div>
            <div class="form-group">
                <label for="description">Flood Description (Optional)</label>
                <textarea id="description" rows="3" placeholder="Describe the flooding situation"></textarea>
            </div>
            <div class="form-group">
                <button type="button" id="geolocate">Use My Current Location</button>
            </div>
            <div class="form-group">
                <button type="submit">Submit Alert</button>
            </div>
        </form>

        <div class="alert-list" id="alertList">
            <h2>Reported Flood Alerts</h2>
            <button class="clear-alerts" id="clearAlerts">Clear All Alerts</button>
        </div>
    </div>
</div>

<!-- Leaflet JS for mapping -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // ------------------ SETUP ------------------
    const map = L.map('map', {
        // Set maximum bounds to restrict panning to Ajax, Ontario (approximate bounds)
        maxBounds: L.latLngBounds([43.80, -79.10], [43.90, -78.95])
    }).setView([43.85012800, -79.03288500], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let alerts = [];
    let tempMarker = null; // Temporary marker for double-clicked location
    const severityColors = {
        mild: { color: '#FFD700', fillColor: '#FFD700', fillOpacity: 0.3 },
        medium: { color: '#FFA500', fillColor: '#FFA500', fillOpacity: 0.3 },
        severe: { color: '#FF4500', fillColor: '#FF4500', fillOpacity: 0.3 }
    };

    // Helper shortcut for DOM access
    const $ = (id) => document.getElementById(id);

    // ------------------ LOCAL STORAGE ------------------
    function saveAlerts() {
        localStorage.setItem('floodAlerts', JSON.stringify(alerts));
    }

    function loadAlerts() {
        const stored = localStorage.getItem('floodAlerts');
        if (stored) {
            try {
                alerts = JSON.parse(stored);
                alerts.forEach(alert => {
                    // Re-add marker to map for each alert
                    addAlertToMap(alert, false);
                    addAlertToList(alert);
                });
            } catch (e) {
                console.error('Error loading alerts:', e);
            }
        }
    }

    // ------------------ HELPER FUNCTIONS ------------------
    // Add marker to the map based on alert data
    function addAlertToMap(alert, bindPopup = true) {
        const { latitude, longitude, description, severity, timestamp, locationAddress } = alert;
        const marker = L.circle([latitude, longitude], {
            radius: 200,
            ...severityColors[severity]
        }).addTo(map);
        if (bindPopup) {
            marker.bindPopup(
                `<strong>Flood Alert (${severity.toUpperCase()})</strong><br>
          ${description}<br>
          ${locationAddress ? `<strong>Location:</strong> ${locationAddress}<br>` : ''}
          <em>${new Date(timestamp).toLocaleString()}</em>`
            );
        }
        // Save the marker's Leaflet ID for removal later
        alert.markerId = marker._leaflet_id;
    }

    // Add alert details to the sidebar list
    function addAlertToList(alert) {
        const { latitude, longitude, description, severity, timestamp, locationAddress } = alert;
        const item = document.createElement('div');
        item.className = 'alert-item';
        item.id = `alert-${alert.markerId}`;
        item.innerHTML = `
        <strong>Location:</strong> ${locationAddress ? locationAddress : `(${latitude.toFixed(4)}, ${longitude.toFixed(4)})`}<br>
        <strong>Severity:</strong> ${severity.charAt(0).toUpperCase() + severity.slice(1)}<br>
        <strong>Description:</strong> ${description}<br>
        <strong>Time:</strong> ${new Date(timestamp).toLocaleString()}
        <button class="remove-alert"></button>
      `;
        $('alertList').appendChild(item);
        // Remove individual alert when its button is clicked
        item.querySelector('.remove-alert').addEventListener('click', () => removeAlert(alert.markerId, item.id));
    }

    // Remove alert from map, alerts array, and sidebar list
    function removeAlert(markerId, elementId) {
        map.eachLayer(layer => {
            if (layer._leaflet_id === markerId) {
                map.removeLayer(layer);
            }
        });
        alerts = alerts.filter(alert => alert.markerId !== markerId);
        const el = $(elementId);
        if (el) el.remove();
        saveAlerts();
    }

    // Calculate distance (in km) using the Haversine formula
    function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) ** 2;
        return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }
    function toRad(deg) { return deg * Math.PI / 180; }

    // ------------------ EVENT LISTENERS ------------------
    // 1) Flood alert reporting with address geocoding
    $('alertForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const description = $('description').value;
        const severity = $('severity').value;
        const locationInput = $('location').value;
        // Append 'Ajax, Ontario' to the location query to ensure results are from Ajax, Ontario.
        const query = `${locationInput}, Ajax, Ontario`;
        // Geocode the address entered
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                if (data.length === 0) {
                    alert('Location not found in Ajax, Ontario. Please enter a valid street name.');
                    return;
                }
                const place = data[0];
                const latitude = parseFloat(place.lat);
                const longitude = parseFloat(place.lon);
                const timestamp = new Date().toISOString();
                const newAlert = { description, latitude, longitude, severity, timestamp, locationAddress: place.display_name };
                alerts.push(newAlert);
                addAlertToMap(newAlert);
                addAlertToList(newAlert);
                saveAlerts();
                e.target.reset();
                // Remove temporary marker if set
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
            })
            .catch(err => alert(`Error geocoding address: ${err}`));
    });

    // 2) Geolocation button for reporting flood (reverse geocoding)
    $('geolocate').addEventListener('click', () => {
        if (!navigator.geolocation) {
            alert('Geolocation not supported by your browser.');
            return;
        }
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                // Reverse geocode to get address, ensuring it is in Ajax, Ontario if possible
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.display_name && data.display_name.includes("Ajax")) {
                            $('location').value = data.display_name;
                        } else {
                            $('location').value = `${lat}, ${lon} (Not in Ajax, Ontario)`;
                        }
                    })
                    .catch(err => {
                        $('location').value = `${lat}, ${lon}`;
                    });
            },
            () => alert('Unable to retrieve your location.')
        );
    });

    // 3) Double-click on the map to auto-fill location field and place a temporary marker
    map.on('dblclick', (e) => {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;

        // Remove any existing temporary marker
        if (tempMarker) {
            map.removeLayer(tempMarker);
        }
        // Place a small marker at the clicked location
        tempMarker = L.marker([lat, lon]).addTo(map);

        // Reverse geocode the clicked coordinates
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
            .then(res => res.json())
            .then(data => {
                // Check if the response contains an address and a road
                if (data && data.address) {
                    const houseNumber = data.address.house_number ? data.address.house_number + ' ' : '';
                    const road = data.address.road || '';
                    // If there's a valid road, use it; otherwise fallback to coordinates
                    if (road) {
                        $('location').value = houseNumber + road;
                    } else {
                        $('location').value = `${lat}, ${lon}`;
                    }
                } else {
                    $('location').value = `${lat}, ${lon}`;
                }
            })
            .catch(err => {
                $('location').value = `${lat}, ${lon}`;
            });
    });

    // 4) Clear All Alerts
    $('clearAlerts').addEventListener('click', () => {
        if (confirm('Are you sure you want to clear all alerts?')) {
            // Remove markers from the map
            map.eachLayer(layer => {
                if (layer instanceof L.Circle && layer._leaflet_id) {
                    if (alerts.find(alert => alert.markerId === layer._leaflet_id)) {
                        map.removeLayer(layer);
                    }
                }
            });
            alerts = [];
            $('alertList').innerHTML = '<h2>Reported Flood Alerts</h2><button class="clear-alerts" id="clearAlerts">Clear All Alerts</button>';
            saveAlerts();
            // Reattach clear alerts listener after resetting innerHTML
            $('clearAlerts').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all alerts?')) {
                    alerts = [];
                    map.eachLayer(layer => {
                        if (layer instanceof L.Circle && layer._leaflet_id) {
                            if (alerts.find(alert => alert.markerId === layer._leaflet_id)) {
                                map.removeLayer(layer);
                            }
                        }
                    });
                    $('alertList').innerHTML = '<h2>Reported Flood Alerts</h2><button class="clear-alerts" id="clearAlerts">Clear All Alerts</button>';
                    saveAlerts();
                }
            });
        }
    });

    // 5) Toggle Dark Mode
    $('toggleTheme').addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
    });

    // Load alerts from localStorage on startup
    loadAlerts();
</script>
</body>
</html>
